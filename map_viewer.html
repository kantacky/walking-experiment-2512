<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walking Experiment Data Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            max-width: 250px;
        }
        .legend.visible {
            display: block;
        }
        .legend h4 {
            margin: 0 0 10px 0;
        }
        .legend-item {
            margin: 5px 0;
            display: flex;
            align-items: center;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid #333;
        }
        .sidebar {
            position: absolute;
            top: 10px;
            left: 10px;
            bottom: 10px;
            width: 320px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        .sidebar.hidden {
            transform: translateX(-340px);
        }
        .sidebar-toggle {
            position: absolute;
            top: 10px;
            left: 60px;
            background: white;
            color: #333;
            border: none;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            padding: 12px 15px;
            z-index: 999;
            font-size: 20px;
            transition: all 0.3s ease;
            display: none;
            width: 50px;
            height: 50px;
            align-items: center;
            justify-content: center;
        }
        .sidebar-toggle.visible {
            display: flex;
        }
        .sidebar-toggle:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }
        .toggle-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: white;
            border: 1px solid #ddd;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 8px 12px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .toggle-button:hover {
            background: #f0f0f0;
            color: #333;
        }
        .sidebar-header {
            padding: 15px;
            padding-right: 60px;
            border-bottom: 2px solid #e0e0e0;
            background: #f8f9fa;
            position: relative;
        }
        .sidebar-header h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #333;
        }
        .sidebar-header input[type="file"] {
            margin: 10px 0;
            padding: 8px;
            width: 100%;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .sidebar-stats {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        .sidebar-stats > div {
            margin: 5px 0;
        }
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .sidebar-content::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .sidebar-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .sidebar-content h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }
        .session-controls {
            margin-bottom: 15px;
        }
        .session-controls button {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        .session-controls button:hover {
            background: #0056b3;
        }
        .fit-bounds-button {
            width: 100%;
            padding: 10px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 500;
        }
        .fit-bounds-button:hover {
            background: #218838;
        }
        .session-item {
            margin: 8px 0;
            padding: 8px;
            border-bottom: 1px solid #eee;
            border-radius: 3px;
            transition: background 0.2s;
        }
        .session-item:hover {
            background: #f8f9fa;
        }
        .session-item label {
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 13px;
        }
        .session-item input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
        }
        .session-item span {
            flex: 1;
            word-break: break-all;
        }
        .session-color-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-left: 8px;
            border: 2px solid #333;
            flex-shrink: 0;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2000;
        }
    </style>
</head>
<body>
    <div id="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
    <div id="map"></div>

    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">â˜°</button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="toggle-button" onclick="toggleSidebar()" title="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹">Â«</button>
            <h3>Walking Experiment Viewer</h3>
            <input type="file" id="fileUpload" accept=".json" multiple onchange="handleFileUpload(event)">
            <div class="sidebar-stats">
                <div id="uploadedCount">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿: 0ãƒ•ã‚¡ã‚¤ãƒ«</div>
                <div id="markerCount">ãƒãƒ¼ã‚«ãƒ¼æ•°: 0</div>
            </div>
        </div>
        <div class="sidebar-content" id="sidebarContent">
            <div style="color: #999; text-align: center; padding: 20px;">
                JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
            </div>
        </div>
    </div>

    <div class="legend" id="legend">
        <h4>ã‚«ãƒ†ã‚´ãƒª</h4>
        <div id="legendContent"></div>
    </div>

    <script>
        // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è‰²è¨­å®š
        const categoryColors = {
            'building': '#e74c3c',
            'landscape': '#3498db',
            'plant': '#2ecc71',
            'vehicle': '#f39c12',
            'person': '#9b59b6',
            'default': '#95a5a6'
        };

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã®è‰²ã‚’ç”Ÿæˆ
        function getSessionColor(sessionIndex) {
            const colors = [
                '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b',
                '#d35400', '#8e44ad', '#2980b9', '#27ae60', '#f1c40f'
            ];
            return colors[sessionIndex % colors.length];
        }

        // åœ°å›³ã®åˆæœŸåŒ–
        const map = L.map('map').setView([41.79, 140.745], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // ãƒãƒ¼ã‚«ãƒ¼ã‚’ç®¡ç†ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—
        let markersLayer = L.featureGroup().addTo(map);

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
        let uploadedFiles = [];
        let allSessions = []; // å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜

        // ãƒ‡ãƒ¼ã‚¿ã‚’åœ°å›³ä¸Šã«ãƒ—ãƒ­ãƒƒãƒˆ
        function plotData(sessions, filename, categoriesSet, sessionStartIndex = 0) {
            let markerCount = 0;

            sessions.forEach((session, sessionLocalIndex) => {
                if (session.records) {
                    const sessionIndex = sessionStartIndex + sessionLocalIndex;
                    const sessionColor = getSessionColor(sessionIndex);
                    const pathCoordinates = [];

                    session.records.forEach(record => {
                        const lat = record.latitude;
                        const lon = record.longitude;
                        const category = record.category || 'unknown';
                        const color = categoryColors[category] || categoryColors['default'];

                        // ã‚«ãƒ†ã‚´ãƒªã‚’åé›†
                        if (categoriesSet) {
                            categoriesSet.add(category);
                        }

                        // è»Œè·¡ã®åº§æ¨™ã‚’è¿½åŠ 
                        pathCoordinates.push([lat, lon]);

                        const marker = L.circleMarker([lat, lon], {
                            radius: 6,
                            fillColor: color,
                            color: '#000',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.7
                        });

                        const popupContent = `
                            <strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${filename}<br>
                            <strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³ID:</strong> ${session.id}<br>
                            <strong>ã‚«ãƒ†ã‚´ãƒª:</strong> ${category}<br>
                            <strong>ç·¯åº¦:</strong> ${lat}<br>
                            <strong>çµŒåº¦:</strong> ${lon}<br>
                            <strong>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—:</strong> ${record.timestamp}
                        `;

                        marker.bindPopup(popupContent);
                        marker.addTo(markersLayer);
                        markerCount++;
                    });

                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®è»Œè·¡ã‚’ç·šã§çµã¶
                    if (pathCoordinates.length > 1) {
                        const polyline = L.polyline(pathCoordinates, {
                            color: sessionColor,
                            weight: 3,
                            opacity: 0.7,
                            smoothFactor: 1
                        });

                        polyline.bindPopup(`
                            <strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${filename}<br>
                            <strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³ID:</strong> ${session.id}<br>
                            <strong>ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°:</strong> ${pathCoordinates.length}
                        `);

                        polyline.addTo(markersLayer);
                    }
                }
            });

            return markerCount;
        }

        // ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã‚’æ›´æ–°
        function updateLegend(categories) {
            const legend = document.getElementById('legend');
            const legendContent = document.getElementById('legendContent');
            legendContent.innerHTML = '';

            if (categories.size === 0) {
                legend.classList.remove('visible');
                return;
            }

            // ã‚«ãƒ†ã‚´ãƒªã‚’ã‚½ãƒ¼ãƒˆ
            const sortedCategories = Array.from(categories).sort();

            sortedCategories.forEach(category => {
                const color = categoryColors[category] || categoryColors['default'];
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';

                const legendColor = document.createElement('div');
                legendColor.className = 'legend-color';
                legendColor.style.background = color;

                const legendText = document.createElement('span');
                legendText.textContent = category;

                legendItem.appendChild(legendColor);
                legendItem.appendChild(legendText);
                legendContent.appendChild(legendItem);
            });

            // ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã‚’è¡¨ç¤º
            legend.classList.add('visible');
        }

        // åœ°å›³ã‚’ã‚¯ãƒªã‚¢
        function clearMap() {
            markersLayer.clearLayers();
            allSessions = [];
            document.getElementById('markerCount').textContent = 'ãƒãƒ¼ã‚«ãƒ¼æ•°: 0';
            const legend = document.getElementById('legend');
            const legendContent = document.getElementById('legendContent');
            legendContent.innerHTML = '';
            legend.classList.remove('visible');

            const sidebarContent = document.getElementById('sidebarContent');
            sidebarContent.innerHTML = `
                <div style="color: #999; text-align: center; padding: 20px;">
                    JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
                </div>
            `;
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠUIã‚’æ›´æ–°
        function updateSessionSelector() {
            const sidebarContent = document.getElementById('sidebarContent');

            if (allSessions.length === 0) {
                sidebarContent.innerHTML = `
                    <div style="color: #999; text-align: center; padding: 20px;">
                        JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
                    </div>
                `;
                return;
            }

            sidebarContent.innerHTML = `
                <button class="fit-bounds-button" onclick="console.log('Fit button clicked'); fitAllMarkers();">ğŸ“ å…¨ä½“è¡¨ç¤º</button>
                <h4>ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠ</h4>
                <div class="session-controls">
                    <button onclick="selectAllSessions()">å…¨é¸æŠ</button>
                    <button onclick="deselectAllSessions()">å…¨è§£é™¤</button>
                </div>
                <div id="sessionList"></div>
            `;

            const sessionList = document.getElementById('sessionList');

            allSessions.forEach((sessionInfo, index) => {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-item';

                const label = document.createElement('label');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠ
                checkbox.id = `session-${index}`;
                checkbox.onchange = () => updateMapDisplay();

                const text = document.createElement('span');
                text.textContent = `${sessionInfo.filename} - ${sessionInfo.session.id}`;

                const colorIndicator = document.createElement('div');
                colorIndicator.className = 'session-color-indicator';
                colorIndicator.style.backgroundColor = getSessionColor(sessionInfo.globalIndex);

                label.appendChild(checkbox);
                label.appendChild(text);
                label.appendChild(colorIndicator);
                sessionItem.appendChild(label);
                sessionList.appendChild(sessionItem);
            });
        }

        // å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠ
        function selectAllSessions() {
            allSessions.forEach((_, index) => {
                const checkbox = document.getElementById(`session-${index}`);
                if (checkbox) checkbox.checked = true;
            });
            updateMapDisplay();
        }

        // å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³è§£é™¤
        function deselectAllSessions() {
            allSessions.forEach((_, index) => {
                const checkbox = document.getElementById(`session-${index}`);
                if (checkbox) checkbox.checked = false;
            });
            updateMapDisplay();
        }

        // åœ°å›³è¡¨ç¤ºã‚’æ›´æ–°
        function updateMapDisplay() {
            markersLayer.clearLayers();
            const categories = new Set();
            let totalMarkers = 0;

            allSessions.forEach((sessionInfo, index) => {
                const checkbox = document.getElementById(`session-${index}`);
                if (checkbox && checkbox.checked) {
                    const count = plotData([sessionInfo.session], sessionInfo.filename, categories, sessionInfo.globalIndex);
                    totalMarkers += count;
                }
            });

            updateLegend(categories);
            document.getElementById('markerCount').textContent = `ãƒãƒ¼ã‚«ãƒ¼æ•°: ${totalMarkers}`;

            if (totalMarkers > 0 && markersLayer.getLayers().length > 0) {
                map.fitBounds(markersLayer.getBounds(), { padding: [50, 50] });
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å‡¦ç†
        async function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            clearMap();
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            uploadedFiles = [];

            // å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚’Promiseã§ç®¡ç†
            const filePromises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            uploadedFiles.push({
                                name: file.name,
                                data: data
                            });
                            resolve();
                        } catch (error) {
                            console.error(`Error parsing ${file.name}:`, error);
                            alert(`${file.name} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
                            reject(error);
                        }
                    };
                    reader.onerror = () => reject(new Error(`Failed to read ${file.name}`));
                    reader.readAsText(file);
                });
            });

            // å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
            try {
                await Promise.all(filePromises);

                // ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’æ›´æ–°
                document.getElementById('uploadedCount').textContent =
                    `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿: ${uploadedFiles.length}ãƒ•ã‚¡ã‚¤ãƒ«`;

                // å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ§‹ç¯‰
                allSessions = [];
                let globalIndex = 0;
                uploadedFiles.forEach(file => {
                    if (file.data.sessions) {
                        file.data.sessions.forEach(session => {
                            allSessions.push({
                                filename: file.name,
                                session: session,
                                globalIndex: globalIndex
                            });
                            globalIndex++;
                        });
                    }
                });

                // ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠUIã‚’æ›´æ–°
                updateSessionSelector();

                // åœ°å›³ã‚’æ›´æ–°
                updateMapDisplay();

                if (allSessions.length === 0) {
                    alert('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
            } catch (error) {
                console.error('Error loading files:', error);
            } finally {
                loading.style.display = 'none';
            }
        }

        // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');

            sidebar.classList.toggle('hidden');
            sidebarToggle.classList.toggle('visible');
        }

        // å…¨ã¦ã®ãƒãƒ¼ã‚«ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«åœ°å›³ã‚’èª¿æ•´
        function fitAllMarkers() {
            try {
                const layers = markersLayer.getLayers();
                console.log('Layers count:', layers.length);

                if (layers.length > 0) {
                    const bounds = markersLayer.getBounds();
                    console.log('Bounds:', bounds);
                    map.fitBounds(bounds, { padding: [50, 50] });
                    console.log('Fit bounds completed');
                } else {
                    alert('è¡¨ç¤ºã™ã‚‹ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                }
            } catch (error) {
                console.error('Error in fitAllMarkers:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // åˆæœŸèª­ã¿è¾¼ã¿
        window.onload = () => {
            document.getElementById('loading').style.display = 'none';
        };
    </script>
</body>
</html>
