<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„Éï„Ç©„Éà„Ç¶„Ç©„Éº„ÇØ „Éá„Éº„Çø„Éó„É¨„Éì„É•„Éº</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap');
    
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --accent-cyan: #22d3ee;
      --accent-pink: #f472b6;
      --accent-amber: #fbbf24;
      --accent-emerald: #34d399;
      --accent-violet: #a78bfa;
      --accent-rose: #fb7185;
      --accent-sky: #38bdf8;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    header {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
      border-bottom: 1px solid var(--bg-tertiary);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      backdrop-filter: blur(10px);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-pink));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    
    .logo-text {
      font-weight: 700;
      font-size: 1.25rem;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-pink));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .controls {
      display: flex;
      gap: 0.75rem;
      margin-left: auto;
    }
    
    .control-btn {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--bg-tertiary);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-primary);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }
    
    .control-btn:hover {
      background: rgba(34, 211, 238, 0.2);
      border-color: var(--accent-cyan);
    }
    
    .control-btn.active {
      background: rgba(34, 211, 238, 0.3);
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
    }
    
    main {
      flex: 1;
      display: flex;
    }
    
    #map {
      flex: 1;
      z-index: 1;
    }
    
    .sidebar {
      width: 360px;
      background: var(--bg-secondary);
      border-left: 1px solid var(--bg-tertiary);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--bg-tertiary);
      background: var(--bg-primary);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .sidebar-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }
    
    .stat {
      background: var(--bg-tertiary);
      padding: 0.5rem;
      border-radius: 6px;
      text-align: center;
    }
    
    .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--accent-cyan);
    }
    
    .stat-label {
      font-size: 0.625rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .legend {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--bg-tertiary);
    }
    
    .legend-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }
    
    .legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.75rem;
      background: var(--bg-tertiary);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .legend-item:hover {
      border-color: rgba(255,255,255,0.2);
    }
    
    .legend-item.disabled {
      opacity: 0.4;
    }
    
    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    .sessions-list {
      flex: 1;
      padding: 1rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .session-card {
      background: var(--bg-primary);
      border: 1px solid var(--bg-tertiary);
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .session-card:hover {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 20px rgba(34, 211, 238, 0.1);
    }
    
    .session-card.active {
      border-color: var(--accent-cyan);
      background: rgba(34, 211, 238, 0.05);
    }
    
    .session-header {
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      border-bottom: 1px solid var(--bg-tertiary);
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .session-info {
      flex: 1;
    }
    
    .session-id {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .session-meta {
      font-size: 0.8125rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .session-details {
      padding: 0.75rem 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
    }
    
    .category-badge {
      font-size: 0.625rem;
      padding: 0.125rem 0.375rem;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    /* Leaflet customizations */
    .leaflet-container {
      background: var(--bg-primary);
      font-family: 'Noto Sans JP', sans-serif;
    }
    
    .leaflet-popup-content-wrapper {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-radius: 8px;
      border: 1px solid var(--bg-tertiary);
    }
    
    .leaflet-popup-content {
      margin: 0.75rem 1rem;
      font-size: 0.875rem;
    }
    
    .leaflet-popup-tip {
      background: var(--bg-secondary);
      border: 1px solid var(--bg-tertiary);
    }
    
    .popup-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .popup-category {
      font-size: 0.75rem;
      padding: 0.125rem 0.5rem;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .popup-info {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .popup-info span {
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-primary);
    }
    
    .custom-marker {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.8);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      font-size: 10px;
      color: white;
      font-weight: 500;
    }
    
    .file-input-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .file-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    #file-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--accent-cyan);
    }
    
    .leaflet-control-zoom {
      border: none !important;
    }
    
    .leaflet-control-zoom a {
      background: var(--bg-secondary) !important;
      color: var(--text-primary) !important;
      border: 1px solid var(--bg-tertiary) !important;
    }
    
    .leaflet-control-zoom a:hover {
      background: var(--bg-tertiary) !important;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-icon">üìç</div>
      <span class="logo-text">PhotoWalk Viewer</span>
    </div>
    <div class="file-input-wrapper">
      <label class="control-btn" for="file-input">„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</label>
      <input type="file" id="file-input" accept=".json" style="display: none;">
      <span id="file-name">„Éï„Ç°„Ç§„É´Êú™ÈÅ∏Êäû</span>
    </div>
    <div class="controls">
      <button class="control-btn active" id="btn-markers">„Éû„Éº„Ç´„Éº</button>
      <button class="control-btn active" id="btn-paths">ÁµåË∑Ø</button>
      <button class="control-btn" id="btn-fit">ÂÖ®‰ΩìË°®Á§∫</button>
    </div>
  </header>
  
  <main>
    <div id="map"></div>
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Áµ±Ë®àÊÉÖÂ†±</div>
        <div class="stats">
          <div class="stat">
            <div class="stat-value" id="stat-users">-</div>
            <div class="stat-label">„É¶„Éº„Ç∂„Éº</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="stat-sessions">-</div>
            <div class="stat-label">„Çª„ÉÉ„Ç∑„Éß„É≥</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="stat-records">-</div>
            <div class="stat-label">ÊíÆÂΩ±Êï∞</div>
          </div>
        </div>
      </div>
      
      <div class="legend">
        <div class="legend-title">„Ç´„ÉÜ„Ç¥„É™</div>
        <div class="legend-items" id="legend-items"></div>
      </div>
      
      <div class="sessions-list" id="sessions-list">
        <p style="color: var(--text-secondary); font-size: 0.875rem; text-align: center; padding: 2rem;">
          JSON„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ
        </p>
      </div>
    </aside>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const CATEGORY_CONFIG = {
      traffic_light: { color: '#ef4444', icon: 'üö¶', label: '‰ø°Âè∑Ê©ü' },
      crosswalk: { color: '#f97316', icon: 'üö∂', label: 'Ê®™Êñ≠Ê≠©ÈÅì' },
      vending_machine: { color: '#eab308', icon: 'ü•§', label: 'Ëá™Ë≤©Ê©ü' },
      shop_sign: { color: '#22c55e', icon: 'üè™', label: 'ÁúãÊùø' },
      bus_stop: { color: '#06b6d4', icon: 'üöå', label: '„Éê„ÇπÂÅú' },
      manhole: { color: '#8b5cf6', icon: '‚≠ï', label: '„Éû„É≥„Éõ„Éº„É´' },
      bench: { color: '#ec4899', icon: 'ü™ë', label: '„Éô„É≥„ÉÅ' }
    };

    const USER_COLORS = [
      '#22d3ee', '#f472b6', '#fbbf24', '#34d399', '#a78bfa',
      '#fb7185', '#38bdf8', '#4ade80', '#f59e0b', '#e879f9'
    ];

    // Map initialization
    const map = L.map('map', {
      center: [41.789, 140.72],
      zoom: 14,
      zoomControl: true
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    // State
    let dataset = null;
    let markersLayer = L.layerGroup().addTo(map);
    let pathsLayer = L.layerGroup().addTo(map);
    let showMarkers = true;
    let showPaths = true;
    let activeCategories = new Set(Object.keys(CATEGORY_CONFIG));
    let activeSession = null;
    let userColorMap = {};

    // Create legend
    function createLegend() {
      const container = document.getElementById('legend-items');
      container.innerHTML = '';
      
      Object.entries(CATEGORY_CONFIG).forEach(([key, config]) => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.dataset.category = key;
        item.innerHTML = `
          <div class="legend-color" style="background: ${config.color}"></div>
          <span>${config.icon} ${config.label}</span>
        `;
        item.addEventListener('click', () => toggleCategory(key));
        container.appendChild(item);
      });
    }

    function toggleCategory(category) {
      if (activeCategories.has(category)) {
        activeCategories.delete(category);
      } else {
        activeCategories.add(category);
      }
      updateLegendUI();
      renderData();
    }

    function updateLegendUI() {
      document.querySelectorAll('.legend-item').forEach(item => {
        const category = item.dataset.category;
        item.classList.toggle('disabled', !activeCategories.has(category));
      });
    }

    // Create custom marker
    function createMarker(record, userColor) {
      const config = CATEGORY_CONFIG[record.category] || { color: '#666', icon: 'üìç' };
      
      const icon = L.divIcon({
        className: 'custom-marker-wrapper',
        html: `<div class="custom-marker" style="background: ${config.color}">${config.icon}</div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });

      const marker = L.marker([record.latitude, record.longitude], { icon });
      
      const popupContent = `
        <div class="popup-header">
          <span class="popup-category" style="background: ${config.color}">${config.label}</span>
        </div>
        <div class="popup-info">
          <div>ÊôÇÂàª: <span>${new Date(record.timestamp).toLocaleString('ja-JP')}</span></div>
          <div>Á∑ØÂ∫¶: <span>${record.latitude.toFixed(6)}</span></div>
          <div>ÁµåÂ∫¶: <span>${record.longitude.toFixed(6)}</span></div>
          <div>ID: <span style="font-size: 0.625rem">${record.id}</span></div>
        </div>
      `;
      
      marker.bindPopup(popupContent);
      return marker;
    }

    // Render data on map
    function renderData() {
      markersLayer.clearLayers();
      pathsLayer.clearLayers();
      
      if (!dataset) return;

      const allBounds = [];

      dataset.sessions.forEach((session, idx) => {
        const userColor = userColorMap[session.user_id] || USER_COLORS[idx % USER_COLORS.length];
        const filteredRecords = session.records.filter(r => activeCategories.has(r.category));
        
        if (activeSession && activeSession !== session.id) return;

        // Add markers
        if (showMarkers) {
          filteredRecords.forEach(record => {
            const marker = createMarker(record, userColor);
            markersLayer.addLayer(marker);
            allBounds.push([record.latitude, record.longitude]);
          });
        }

        // Add path
        if (showPaths && session.records.length > 1) {
          const pathCoords = session.records.map(r => [r.latitude, r.longitude]);
          const path = L.polyline(pathCoords, {
            color: userColor,
            weight: 3,
            opacity: 0.7,
            dashArray: '5, 10'
          });
          pathsLayer.addLayer(path);
          pathCoords.forEach(c => allBounds.push(c));
        }
      });

      return allBounds;
    }

    // Update stats
    function updateStats() {
      if (!dataset) return;
      
      const users = new Set(dataset.sessions.map(s => s.user_id));
      const totalRecords = dataset.sessions.reduce((sum, s) => sum + s.records.length, 0);
      
      document.getElementById('stat-users').textContent = users.size;
      document.getElementById('stat-sessions').textContent = dataset.sessions.length;
      document.getElementById('stat-records').textContent = totalRecords;
    }

    // Render sessions list
    function renderSessionsList() {
      const container = document.getElementById('sessions-list');
      
      if (!dataset || dataset.sessions.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.875rem; text-align: center; padding: 2rem;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        return;
      }

      // Assign colors to users
      const userIds = [...new Set(dataset.sessions.map(s => s.user_id))];
      userIds.forEach((uid, idx) => {
        userColorMap[uid] = USER_COLORS[idx % USER_COLORS.length];
      });

      container.innerHTML = dataset.sessions.map((session, idx) => {
        const userColor = userColorMap[session.user_id];
        const userIndex = userIds.indexOf(session.user_id) + 1;
        const categoryCounts = {};
        session.records.forEach(r => {
          categoryCounts[r.category] = (categoryCounts[r.category] || 0) + 1;
        });

        const firstTimestamp = session.records[0]?.timestamp;
        const dateStr = firstTimestamp ? new Date(firstTimestamp).toLocaleDateString('ja-JP') : '-';

        return `
          <div class="session-card" data-session-id="${session.id}">
            <div class="session-header">
              <div class="user-avatar" style="background: ${userColor}">U${userIndex}</div>
              <div class="session-info">
                <div class="session-meta">
                  <span>${dateStr}</span>
                  <span style="color: var(--text-secondary)">‚Ä¢</span>
                  <span>${session.records.length}‰ª∂</span>
                </div>
                <div class="session-id">${session.id.slice(0, 8)}...</div>
              </div>
            </div>
            <div class="session-details">
              ${Object.entries(categoryCounts).map(([cat, count]) => {
                const config = CATEGORY_CONFIG[cat] || { color: '#666', label: cat };
                return `<span class="category-badge" style="background: ${config.color}20; color: ${config.color}">${config.icon} ${count}</span>`;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers
      container.querySelectorAll('.session-card').forEach(card => {
        card.addEventListener('click', () => {
          const sessionId = card.dataset.sessionId;
          
          if (activeSession === sessionId) {
            activeSession = null;
            card.classList.remove('active');
          } else {
            container.querySelectorAll('.session-card').forEach(c => c.classList.remove('active'));
            activeSession = sessionId;
            card.classList.add('active');
          }
          
          const bounds = renderData();
          if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [50, 50] });
          }
        });
      });
    }

    // Load JSON file
    function loadJSON(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          dataset = JSON.parse(e.target.result);
          document.getElementById('file-name').textContent = file.name;
          
          updateStats();
          renderSessionsList();
          const bounds = renderData();
          
          if (bounds && bounds.length > 0) {
            map.fitBounds(bounds, { padding: [50, 50] });
          }
        } catch (err) {
          alert('JSON„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // Event listeners
    document.getElementById('file-input').addEventListener('change', (e) => {
      if (e.target.files[0]) {
        loadJSON(e.target.files[0]);
      }
    });

    document.getElementById('btn-markers').addEventListener('click', (e) => {
      showMarkers = !showMarkers;
      e.target.classList.toggle('active', showMarkers);
      renderData();
    });

    document.getElementById('btn-paths').addEventListener('click', (e) => {
      showPaths = !showPaths;
      e.target.classList.toggle('active', showPaths);
      renderData();
    });

    document.getElementById('btn-fit').addEventListener('click', () => {
      if (!dataset) return;
      const allCoords = [];
      dataset.sessions.forEach(s => {
        s.records.forEach(r => allCoords.push([r.latitude, r.longitude]));
      });
      if (allCoords.length > 0) {
        map.fitBounds(allCoords, { padding: [50, 50] });
      }
    });

    // Initialize
    createLegend();

    // Auto-load default file
    fetch('data/20251224T001254Z.json')
      .then(res => res.json())
      .then(data => {
        dataset = data;
        document.getElementById('file-name').textContent = '20251224T001254Z.json';
        updateStats();
        renderSessionsList();
        const bounds = renderData();
        if (bounds && bounds.length > 0) {
          map.fitBounds(bounds, { padding: [50, 50] });
        }
      })
      .catch(() => {
        console.log('„Éá„Éï„Ç©„É´„Éà„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åó„Åü');
      });
  </script>
</body>
</html>

